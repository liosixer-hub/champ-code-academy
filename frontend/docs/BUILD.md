# Build 脚本文档

## 概述

`build.js` 是一个用于构建前端微前端项目的自动化脚本。该脚本支持构建单个模块或批量构建所有模块，并提供交互式和非交互式两种使用模式。

## 功能特性

- **模块化构建**：支持构建指定的单个模块或所有模块
- **交互式选择**：在终端中运行时提供交互式模块选择界面
- **环境变量支持**：通过 `.env.production` 文件中的 `BUILD_MODULES` 变量控制构建范围
- **自动类型生成**：构建完成后自动生成远程模块类型声明文件
- **构建产物管理**：自动复制构建产物到指定目录
- **错误处理**：单个模块构建失败不影响其他模块的构建

## 项目结构

```
frontend/
├── src/
│   ├── apps/          # 应用模块
│   │   ├── dashboard/
│   │   ├── home/
│   │   ├── login/
│   │   └── ...
│   ├── host/          # 主应用
│   └── shared/        # 共享模块
├── dist/              # 构建产物输出目录
├── scripts/
│   └── build.js       # 构建脚本
└── .env.production    # 生产环境配置
```

## 使用方法

### 交互式模式

当在支持交互的终端中运行且不提供命令行参数时，脚本会进入交互式模式：

```bash
node scripts/build.js
```

脚本会：
1. 列出所有可用的模块及其编号
2. 提示用户输入模块名或编号
3. 支持输入 "all" 来构建所有模块

**示例输出：**
```
可用的模块：
1. dashboard
2. home
3. login
4. host
5. shared
输入模块名或编号来构建指定模块，输入 "all" 构建所有模块：
请选择: shared
```

### 非交互式模式

通过命令行参数直接指定要构建的模块：

```bash
# 构建指定模块
node scripts/build.js --module shared
node scripts/build.js shared

# 构建所有模块
node scripts/build.js

# 显示帮助信息
node scripts/build.js --help
```

## 参数说明

| 参数 | 描述 | 示例 |
|------|------|------|
| `--module <模块名>` | 指定要构建的模块名 | `--module shared` |
| `--help`, `-h` | 显示帮助信息 | `--help` |
| `<模块名>` | 直接指定模块名（位置参数） | `shared` |

## 环境变量

### BUILD_MODULES

通过 `.env.production` 文件中的 `BUILD_MODULES` 变量可以控制默认构建的模块范围：

```env
BUILD_MODULES=dashboard,home,shared
```

- 如果设置了此变量，脚本在构建所有模块时只会构建列出的模块
- 如果未设置此变量，则构建所有找到的模块
- 变量值应为逗号分隔的模块名列表

## 构建流程

1. **环境检查**：检查并创建 `dist` 输出目录
2. **模块发现**：递归扫描 `src` 目录，查找包含 `package.json` 的项目
3. **模块过滤**：根据用户选择或环境变量过滤要构建的模块
4. **逐个构建**：
   - 进入模块目录
   - 执行 `pnpm build` 命令
   - 复制构建产物到 `frontend/dist` 目录

## 构建产物

构建完成后，产物会被复制到以下位置：

- `host` 模块 → `frontend/dist/` （根目录）
- 其他模块 → `frontend/dist/<模块名>/`

## 类型声明文件


## 示例

### 示例 1：构建单个模块

```bash
node scripts/build.js --module shared
```

输出：
```
目标: shared
将构建的项目： [ 'shared' ]

开始构建项目: shared
...
项目 shared 构建完成，dist 已复制到 dist\shared

所有项目构建完成！

生成远程模块类型声明文件...
✅ 类型声明文件已生成
```

### 示例 2：交互式构建

```bash
node scripts/build.js
```

然后在提示中输入 `dashboard` 或 `1`（如果 dashboard 是第一个模块）。

### 示例 3：构建所有模块

```bash
node scripts/build.js
```

或在交互式模式中输入 `all`。

## 注意事项

1. **依赖关系**：确保所有模块的依赖都已正确安装
2. **构建顺序**：脚本按找到的顺序构建模块，不保证特定的构建顺序
3. **错误处理**：单个模块构建失败不会阻止其他模块的构建
4. **环境变量**：`.env.production` 文件需要与脚本在同一目录下
5. **权限问题**：确保脚本有足够的权限创建目录和执行构建命令

## 故障排除

### 模块未找到

如果出现 "未找到项目" 错误，请检查：
- 模块目录是否存在
- 模块目录下是否有 `package.json` 文件
- 模块名是否正确

### 构建失败

如果某个模块构建失败：
- 检查该模块的依赖是否正确安装
- 查看具体的错误信息
- 其他模块仍会继续构建

### 类型生成失败

如果类型声明文件生成失败：
- 确保所有模块的构建产物都正确生成
- 查看具体的错误信息

## 相关文档

- [开发指南](./DEV.md)
- [创建应用指南](./CREATE_APP_GUIDE.md)
- [类型声明生成](./DTS_GENERATION.md)
- [预览指南](./PREVIEW.md)